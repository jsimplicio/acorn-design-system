---
name: Sync from Firefox Repository

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
      - master
    paths:
      - '.github/workflows/sync-from-firefox.yml'

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Acorn Design System repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'

      - name: Sparse checkout Firefox design-system directory
        run: |
          echo "ðŸ¦Š Setting up sparse checkout for design-system directory..."
          git clone --filter=blob:none --no-checkout https://github.com/mozilla/firefox.git firefox-repo
          cd firefox-repo
          git sparse-checkout init --cone
          git sparse-checkout set toolkit/themes/shared/design-system
          git checkout
          echo "âœ… Successfully checked out design-system directory only"

      - name: Check for changes in design-system
        id: check_changes
        run: |
          echo "ðŸ” Checking for changes in design-system directory..."
          DESIGN_SYSTEM_PATH="firefox-repo/toolkit/themes/shared/design-system"
          if [ ! -d "$DESIGN_SYSTEM_PATH" ]; then
            echo "âŒ Design system directory not found in Firefox repo"
            exit 1
          fi
          mkdir -p temp-comparison
          rsync -av --exclude='.git*' --exclude='node_modules' "$DESIGN_SYSTEM_PATH/" temp-comparison/
          if ! diff -r --exclude='.git*' --exclude='node_modules' --exclude='.github' --exclude='acorn-utils' --exclude='acorn-tokens' --exclude='tokens-config.js' --exclude='tokens-*.json' --exclude='tokens-*.mjs' --exclude='package*.json' --exclude='.prettierrc' --exclude='build' . temp-comparison/ > /dev/null 2>&1; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Changes detected in Firefox design-system!"
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "âœ… No changes detected. Repository is up to date."
          fi
          rm -rf temp-comparison

      - name: Sync changes from Firefox
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          echo "ðŸ”„ Syncing changes from Firefox repository..."
          DESIGN_SYSTEM_PATH="firefox-repo/toolkit/themes/shared/design-system"
          echo "ðŸ“‹ Copying files from Firefox repository..."
          echo "rsync command: rsync -av --delete --force --ignore-errors --exclude='.git*' --exclude='node_modules' --exclude='.github' --exclude='README.md' --exclude='LICENSE' --exclude='package*.json' --exclude='acorn-utils' --exclude='acorn-tokens' --exclude='tokens-config.js' --exclude='tokens-*.json' --exclude='tokens-*.mjs' --exclude='build' $DESIGN_SYSTEM_PATH/ ./"
          rsync -av --delete --force --ignore-errors \
            --exclude='.git*' \
            --exclude='node_modules' \
            --exclude='.github' \
            --exclude='README.md' \
            --exclude='LICENSE' \
            --exclude='package*.json' \
            --exclude='.prettierrc' \
            --exclude='acorn-utils' \
            --exclude='acorn-tokens' \
            --exclude='tokens-config.js' \
            --exclude='tokens-*.json' \
            --exclude='tokens-*.mjs' \
            --exclude='build' \
            "$DESIGN_SYSTEM_PATH/" ./ || {
            RSYNC_EXIT_CODE=$?
            echo "âš ï¸ rsync completed with exit code $RSYNC_EXIT_CODE"
            if [ $RSYNC_EXIT_CODE -eq 24 ]; then
              echo "â„¹ï¸ Exit code 24: Some files vanished during transfer (non-critical)"
            elif [ $RSYNC_EXIT_CODE -eq 23 ]; then
              echo "â„¹ï¸ Exit code 23: Partial transfer due to error (continuing)"
            elif [ $RSYNC_EXIT_CODE -gt 25 ]; then
              echo "âŒ Critical rsync error (exit code $RSYNC_EXIT_CODE)"
              exit 1
            else
              echo "â„¹ï¸ Minor rsync issues, continuing..."
            fi
          }

          echo ""
          echo "Git status after rsync:"
          git status

          echo ""
          echo "Git diff after rsync:"
          git diff --stat

          cd firefox-repo
          FIREFOX_COMMIT=$(git rev-parse HEAD)
          FIREFOX_COMMIT_SHORT=$(git rev-parse --short HEAD)
          cd ..

          echo "Firefox commit: $FIREFOX_COMMIT_SHORT"

          git add .

          if git diff --cached --quiet; then
            echo "No changes to commit after sync"
          else
            git commit -m "Sync from Firefox repository\n\nSynced from mozilla/firefox commit: $FIREFOX_COMMIT_SHORT\nDate: $(date '+%Y-%m-%d %H:%M:%S UTC')\nSource: https://github.com/mozilla/firefox/commit/$FIREFOX_COMMIT"
            echo "Changes committed successfully!"
          fi

      - name: Push changes
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          echo "ðŸš€ Pushing changes to repository..."
          git push origin ${{ github.ref_name }}

      - name: Create summary
        run: |
          echo "## Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_changes.outputs.changes_detected }}" == "true" ]; then
            echo "âœ… **Changes detected and synced from Firefox repository**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The Acorn Design System has been updated with the latest changes from mozilla/firefox." >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **No changes detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The Acorn Design System is already up to date with the Firefox repository." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Last sync: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: Clean up
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up temporary files..."
          rm -rf firefox-repo temp-comparison
